<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novo Operador — Administração</title>
  <meta name="robots" content="noindex,nofollow" />

  <!-- Ícone/identidade (ajuste se o seu projeto usar outro caminho) -->
  <link rel="icon" href="/imgs/header-senado.png" />

  <style>
    :root {
      --gap: 12px;
      --radius: 10px;
      --shadow: 0 1px 3px rgba(0, 0, 0, .08);
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      background: #f6f7f9;
      color: #1b1f24;
    }

    main {
      max-width: 980px;
      margin: 24px auto 56px;
      padding: 0 16px;
    }

    .card {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: clamp(20px, 2.6vw, 26px);
    }

    .muted {
      color: #616a7a;
      font-size: .94rem;
    }

    .section-title {
      margin: 22px 0 8px;
      font-weight: 700;
      color: #334155;
    }

    .grid {
      display: grid;
      gap: var(--gap);
    }

    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    label {
      font-weight: 600;
      font-size: .96rem;
      display: block;
      margin-bottom: 6px;
    }

    .required::after {
      content: " *";
      color: #d00;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: 1px solid #d7dbe3;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 1rem;
      background: #fff;
    }

    input[type="file"] {
      border: 0;
      padding: 0;
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    button {
      border: 0;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 1rem;
      cursor: pointer;
    }

    .btn-primary {
      background: #0b5ed7;
      color: #fff;
    }

    .btn-secondary {
      background: #e9ecef;
      color: #1b1f24;
    }

    .btn-ghost {
      background: #fff;
      border: 1px dashed #94a3b8;
      color: #0b5ed7;
      border-radius: 999px;
      padding: 10px 14px;
    }

    .upload-wrap {
      display: flex;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
    }

    .file-name {
      color: #475569;
      font-size: .94rem;
    }

    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      display: none;
      border: 1px solid #e2e8f0;
    }

    .hint {
      color: #64748b;
      font-size: .88rem;
    }

    @media (max-width: 720px) {

      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>

<body>

  <!-- HEADER (carregado automaticamente pelo drop-in de sessão) -->
  <div id="app-header"></div>

  <main>
    <div class="card">
      <h1>Novo Operador</h1>
      <p class="muted">Os campos marcados com <strong>*</strong> são obrigatórios.</p>

      <form id="form-novo-operador" novalidate autocomplete="off" enctype="multipart/form-data">
        <div class="grid grid-2">
          <div>
            <label for="nome_completo" class="required">Nome completo</label>
            <input type="text" id="nome_completo" name="nome_completo" required />
          </div>
          <div>
            <label for="email" class="required">E-mail institucional</label>
            <input type="email" id="email" name="email" required />
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label for="username" class="required">Nome de usuário</label>
            <input type="text" id="username" name="username" required />
          </div>
          <div>
            <label for="senha" class="required">Senha</label>
            <input type="password" id="senha" name="senha" required />
          </div>
        </div>

        <div class="section-title">Upload de foto <span class="hint">(opcional)</span></div>
        <div class="upload-wrap">
          <img id="foto-preview" class="avatar" alt="Prévia da foto" />
          <input id="foto" name="foto" type="file" accept="image/*" class="sr-only" />
          <button id="btn-foto" class="btn-ghost" type="button">Selecionar arquivo</button>
          <span id="foto-nome" class="file-name">Nenhum arquivo selecionado</span>
        </div>

        <div class="actions">
          <button class="btn-secondary" type="button" id="btn-voltar">Voltar</button>
          <button class="btn-primary" type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </main>

  <!-- FOOTER (carregado automaticamente pelo drop-in de sessão) -->
  <div id="app-footer"></div>

  <!-- Sessão e proteção de página (admin-only) -->
  <script src="/js/session-autoload.js"></script>

  <script>
    (function () {
      const form = document.getElementById("form-novo-operador");
      const btnVoltar = document.getElementById("btn-voltar");
      const inputFile = document.getElementById("foto");
      const btnFile = document.getElementById("btn-foto");
      const fileName = document.getElementById("foto-nome");
      const preview = document.getElementById("foto-preview");

      // 1) URL do Webhook do n8n (produção)
      //    Copie exatamente a Production URL do nó Webhook1 no n8n.
      const N8N_WEBHOOK_URL = "https://senado-nusp.cloud/webhook/admin/operadores/novo";

      // 2) Como pegar o token da sessão (aproveitando o session-autoload.js)
      function getAuthToken() {
        try {
          if (window.Auth && typeof window.Auth.loadToken === "function") {
            return window.Auth.loadToken();
          }
        } catch (e) { }
        return (
          localStorage.getItem("auth_token") ||
          localStorage.getItem("token") ||
          localStorage.getItem("jwt") ||
          ""
        );
      }

      // 3) Botão Voltar → home admin
      btnVoltar.addEventListener("click", function () {
        window.location.href = "/admin/index.html";
      });

      // 4) Botão de escolher arquivo
      btnFile.addEventListener("click", function () {
        inputFile.click();
      });

      // 5) Preview da foto
      inputFile.addEventListener("change", function () {
        if (!inputFile.files || !inputFile.files[0]) {
          fileName.textContent = "Nenhum arquivo selecionado";
          preview.style.display = "none";
          preview.src = "";
          return;
        }
        const f = inputFile.files[0];
        fileName.textContent = f.name + " (" + Math.round(f.size / 1024) + " KB)";
        try {
          const url = URL.createObjectURL(f);
          preview.src = url;
          preview.style.display = "inline-block";
        } catch (_) { }
      });

      // 6) Submit: envia multipart/form-data para o n8n
      form.addEventListener("submit", async function (ev) {
        ev.preventDefault();

        // Validação HTML5
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const email = document.getElementById("email").value.trim();
        const username = document.getElementById("username").value.trim();
        const senha = document.getElementById("senha").value;

        // Regras básicas extras
        if (senha.length < 6) {
          alert("A senha precisa ter pelo menos 6 caracteres.");
          return;
        }
        if (!/^[a-z0-9._-]{3,}$/i.test(username)) {
          alert("Nome de usuário inválido. Use letras, números, ponto, traço ou sublinhado (mín. 3).");
          return;
        }

        // Monta FormData (inclui texto + arquivo)
        const formData = new FormData(form);
        formData.set("email", email);
        formData.set("username", username);

        const submitBtn = form.querySelector('button[type="submit"]');
        const oldLabel = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = "Salvando...";

        try {
          const token = getAuthToken();

          const res = await fetch(N8N_WEBHOOK_URL, {
            method: "POST",
            headers: token ? { "Authorization": "Bearer " + token } : {},
            body: formData
            // NÃO definir Content-Type aqui, o browser cuida do boundary
          });

          // Sessão / permissão
          if (res.status === 401 || res.status === 403) {
            alert("Sua sessão expirou ou você não tem permissão para esta operação.");
            window.location.href = "/index.html";
            return;
          }

          if (res.status === 400) {
            const data = await safeJson(res);
            alert("Dados inválidos: " + (data?.missing || "verifique os campos obrigatórios."));
            return;
          }

          if (res.status === 409) {
            const data = await safeJson(res);
            alert(data?.message || "E-mail ou usuário já cadastrado.");
            return;
          }

          if (!res.ok) {
            const text = await res.text();
            alert("Falha ao salvar (HTTP " + res.status + "): " + text);
            return;
          }

          const data = await safeJson(res);
          const id = data?.operador?.id || "(sem ID)";
          alert("Operador cadastrado com sucesso! ID: " + id);

          // Limpa formulário e preview
          form.reset();
          preview.style.display = "none";
          preview.src = "";
          fileName.textContent = "Nenhum arquivo selecionado";

        } catch (err) {
          console.error(err);
          alert("Erro de rede ou CORS ao comunicar com o n8n.");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = oldLabel;
        }
      });

      async function safeJson(res) {
        try { return await res.json(); } catch { return null; }
      }
    })();
  </script>
</body>

</html>