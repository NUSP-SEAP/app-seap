<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Anormalidade na Operação de Áudio</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root {
      --gap: 12px;
      --radius: 10px;
      --border: #e5e7eb;
      --ink: #0f172a;
    }

    html,
    body {
      margin: 0;
      background: #f6f7f9;
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
    }

    main {
      max-width: 980px;
      margin: 24px auto 56px;
      padding: 0 16px;
    }

    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: clamp(20px, 2.6vw, 26px);
    }

    .muted {
      color: #616a7a;
      font-size: .94rem;
    }

    .section-title {
      margin: 22px 0 8px;
      font-weight: 700;
      color: #334155;
    }

    .grid {
      display: grid;
      gap: var(--gap);
    }

    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .required::after {
      content: " *";
      color: #d00;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: 1px solid #d7dbe3;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 1rem;
      background: #fff;
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .field-inline {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .hidden {
      display: none;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .btn-primary,
    .btn-secondary {
      border: 0;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 1rem;
      cursor: pointer;
    }

    .btn-primary {
      background: #0b5ed7;
      color: #fff;
    }

    .btn-secondary {
      background: #e9ecef;
      color: #1b1f24;
    }

    @media (max-width: 720px) {

      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <main>
    <div class="card">
      <h1>Registro de Anormalidade na Operação de Áudio</h1>
      <p class="muted">Preencha as informações referentes à anormalidade. Campos marcados com * são obrigatórios.</p>
      <p class="muted" id="registro-ref" style="margin-top:-6px;"></p>

      <form id="form-raoa" novalidate>
        <!-- IDs e referências -->
        <input type="hidden" id="registro_id" name="registro_id" />

        <!-- 1) Referência ao Registro de Operação -->
        <div class="section-title">1) Referência ao Registro de Operação</div>
        <div class="grid grid-3">
          <div>
            <div>
              <label class="required" for="data">Data</label>
              <input type="date" id="data" name="data" required />
            </div>
          </div>
          <div>
            <label class="required" for="sala_id">Local do Evento</label>
            <select id="sala_id" name="sala_id" required disabled>
              <option value="">Carregando...</option>
            </select>
          </div>
          <div>
            <label class="required" for="nome_evento">Nome do Evento</label>
            <input type="text" id="nome_evento" name="nome_evento" required />
          </div>
        </div>

        <!-- 2) Detalhes da Anormalidade -->
        <div class="section-title">2) Detalhes da Anormalidade</div>
        <div class="grid grid-3">
          <div>
            <label class="required" for="hora_inicio_anormalidade">Horário de início da anormalidade</label>
            <input type="time" id="hora_inicio_anormalidade" name="hora_inicio_anormalidade" required />
          </div>
          <div>
            <label for="data_solucao">Data da solução da anormalidade</label>
            <input type="date" id="data_solucao" name="data_solucao" />
          </div>
          <div>
            <label for="hora_solucao">Hora da solução da anormalidade</label>
            <input type="time" id="hora_solucao" name="hora_solucao" />
          </div>
        </div>
        <div>
          <label class="required" for="descricao_anormalidade">Descrição da anormalidade</label>
          <textarea id="descricao_anormalidade" name="descricao_anormalidade" required></textarea>
        </div>

        <!-- 3) Impactos e Reclamações (mantido) -->
        <div class="section-title">3) Impactos e Reclamações</div>
        <div class="grid grid-2">
          <div>
            <label class="required">Houve prejuízo ao andamento?</label>
            <div class="field-inline">
              <label><input type="radio" name="houve_prejuizo" value="nao" checked /> Não</label>
              <label><input type="radio" name="houve_prejuizo" value="sim" /> Sim</label>
            </div>
          </div>
          <div id="grp_descricao_prejuizo" class="hidden">
            <label for="descricao_prejuizo">Descrição do prejuízo (opcional)</label>
            <textarea id="descricao_prejuizo" name="descricao_prejuizo"
              placeholder="Se houve, descreva brevemente o prejuízo."></textarea>
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label class="required">Houve reclamação?</label>
            <div class="field-inline">
              <label><input type="radio" name="houve_reclamacao" value="nao" checked /> Não</label>
              <label><input type="radio" name="houve_reclamacao" value="sim" /> Sim</label>
            </div>
          </div>
          <div id="grp_autores_conteudo_reclamacao" class="hidden">
            <label for="autores_conteudo_reclamacao">Autor(es) e conteúdo resumido da(s) reclamação(ões)
              (opcional)</label>
            <textarea id="autores_conteudo_reclamacao" name="autores_conteudo_reclamacao"></textarea>
          </div>
        </div>

        <!-- 4) Manutenção (mantido) -->
        <div class="section-title">4) Manutenção</div>

        <div class="grid grid-2">
          <div>
            <label class="required">Foi necessário acionar manutenção?</label>
            <div class="field-inline">
              <label><input type="radio" name="acionou_manutencao" value="nao" checked /> Não</label>
              <label><input type="radio" name="acionou_manutencao" value="sim" /> Sim</label>
            </div>
          </div>
          <div id="grp_hora_acionamento" class="hidden">
            <label for="hora_acionamento_manutencao">Hora do acionamento da manutenção (opcional)</label>
            <input type="time" id="hora_acionamento_manutencao" name="hora_acionamento_manutencao" />
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label class="required">Anormalidade resolvida pelo próprio operador?</label>
            <div class="field-inline">
              <label><input type="radio" name="resolvida_pelo_operador" value="nao" checked /> Não</label>
              <label><input type="radio" name="resolvida_pelo_operador" value="sim" /> Sim</label>
            </div>
          </div>
          <div id="grp_procedimentos_adotados" class="hidden">
            <label for="procedimentos_adotados">Descrição sucinta dos procedimentos adotados (opcional)</label>
            <textarea id="procedimentos_adotados" name="procedimentos_adotados"></textarea>
          </div>
        </div>

        <!-- 5) Responsáveis (sem "Operador responsável pelo registro") -->
        <div class="section-title">5) Responsáveis</div>
        <div class="grid grid-2">
          <div>
            <label class="required" for="responsavel_evento">Responsável do evento (Comissão/Mesa/Organização)</label>
            <input type="text" id="responsavel_evento" name="responsavel_evento" required
              placeholder="Nome do responsável" />
          </div>
        </div>

        <!-- Ações -->
        <div class="actions">
          <button type="button" class="btn-secondary" id="btn-voltar">Voltar</button>
          <button type="submit" class="btn-primary">Salvar registro</button>
        </div>
      </form>
    </div>
  </main>
  <script>

    // === Lookups ===
    const SALAS_URL = "https://senado-nusp.cloud/webhook/forms/lookup/salas"; // mesmo usado em Operação
    const REGISTRO_ANORMALIDADE_URL = "https://senado-nusp.cloud/webhook/operacao/anormalidade/registro";
    const REGISTRO_LOOKUP_URL = "https://senado-nusp.cloud/webhook/forms/lookup/registro-operacao";

    function getToken() {
      return localStorage.getItem("auth_token") || localStorage.getItem("token") || "";
    }
    async function authFetch(url, options = {}) {
      const headers = Object.assign({}, options.headers || {});
      const tok = getToken();
      if (tok) headers["Authorization"] = "Bearer " + tok;
      return fetch(url, Object.assign({}, options, { headers }));
    }

    function getRegistroIdFromQuery() {
      try {
        const params = new URLSearchParams(window.location.search);
        const rid = params.get("registro_id");
        if (!rid) return null;
        const n = Number(rid);
        if (!Number.isFinite(n) || n <= 0) return null;
        return String(n);
      } catch (e) {
        console.error("Erro ao ler registro_id da URL:", e);
        return null;
      }
    }


    async function loadSalas(prefId = null) {
      const sel = document.getElementById("sala_id");
      sel.innerHTML = '<option value="">Carregando...</option>';
      try {
        const r = await authFetch(SALAS_URL, { method: "GET" });
        const json = await r.json().catch(() => ({}));
        const rows = Array.isArray(json?.data) ? json.data
          : Array.isArray(json?.salas) ? json.salas
            : Array.isArray(json) ? json : [];
        if (!rows.length) throw new Error("lista vazia");
        sel.innerHTML = '<option value="">Selecione...</option>' +
          rows.map(s => `<option value="${s.id}">${s.nome}</option>`).join("");
        sel.disabled = false;
        if (prefId) sel.value = String(prefId);
      } catch (e) {
        console.error("Falha ao carregar salas:", e);
        sel.innerHTML = '<option value="">[Erro ao carregar]</option>';
      }
    }

    async function loadRegistroOperacao(registroId) {
      try {
        const resp = await authFetch(`${REGISTRO_LOOKUP_URL}?id=${encodeURIComponent(registroId)}`, {
          method: "GET",
        });

        const json = await resp.json().catch(() => ({}));

        if (!resp.ok || json.ok === false) {
          console.error("Falha ao buscar registro de operação para anormalidade:", json);
          return null;
        }

        if (!json.data) {
          return null;
        }

        return json.data; // { id, data, sala_id, nome_evento }
      } catch (e) {
        console.error("Erro inesperado ao buscar registro de operação:", e);
        return null;
      }
    }


    // === Regras de exibição condicional (mantidas) ===
    function bindToggles() {
      const toggles = [
        { name: "houve_prejuizo", target: "grp_descricao_prejuizo" },
        { name: "houve_reclamacao", target: "grp_autores_conteudo_reclamacao" },
        { name: "acionou_manutencao", target: "grp_hora_acionamento" },
        { name: "resolvida_pelo_operador", target: "grp_procedimentos_adotados" },
      ];
      toggles.forEach(t => {
        document.querySelectorAll(`input[name="${t.name}"]`).forEach(r => {
          r.addEventListener("change", () => {
            const show = document.querySelector(`input[name="${t.name}"][value="sim"]`).checked;
            document.getElementById(t.target).classList.toggle("hidden", !show);
          });
        });
        // estado inicial
        const show = document.querySelector(`input[name="${t.name}"][value="sim"]`).checked;
        document.getElementById(t.target).classList.toggle("hidden", !show);
      });
    }

    // === Inicialização mínima (somente visual/obrigatoriedade neste passo) ===
    document.addEventListener("DOMContentLoaded", async () => {
      bindToggles();

      const registroId = getRegistroIdFromQuery();
      const registroIdInput = document.getElementById("registro_id");
      const registroRef = document.getElementById("registro-ref");
      const dataInput = document.getElementById("data");
      const salaSelect = document.getElementById("sala_id");
      const nomeEventoInput = document.getElementById("nome_evento");

      // Texto de referência no topo
      if (registroId && registroRef) {
        registroRef.textContent = "Vinculado ao registro de operação nº " + registroId;
      }

      let prefSalaId = null;

      // Se veio registro_id na URL, tenta buscar dados da operação para pré-preencher
      if (registroId) {
        const info = await loadRegistroOperacao(registroId);
        if (info) {
          if (registroIdInput) {
            registroIdInput.value = String(info.id);
          }
          if (dataInput && info.data) {
            dataInput.value = info.data; // formato YYYY-MM-DD aceito pelo input[type=date]
          }
          if (nomeEventoInput && typeof info.nome_evento === "string") {
            nomeEventoInput.value = info.nome_evento;
          }
          if (typeof info.sala_id !== "undefined" && info.sala_id !== null) {
            prefSalaId = info.sala_id;
          }
        } else if (registroIdInput) {
          // fallback: ainda assim guarda o registro_id da URL
          registroIdInput.value = registroId;
        }
      }

      // Carrega salas, tentando já selecionar a da operação (se veio do backend)
      await loadSalas(prefSalaId);

      // Enviar para o backend Django
      const form = document.getElementById("form-raoa");
      form.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        try {
          const resp = await authFetch(REGISTRO_ANORMALIDADE_URL, {
            method: "POST",
            body: new FormData(form),
          });

          let data = {};
          try {
            data = await resp.json();
          } catch (e) {
            data = {};
          }

          if (!resp.ok || data.ok === false) {
            let msg = "Erro ao salvar o formulário de anormalidade.";
            if (data && data.errors) {
              msg += "\n\nDetalhes:\n" + JSON.stringify(data.errors, null, 2);
            } else if (data && data.error) {
              msg += "\n\n" + data.error;
            }
            alert(msg);
            return;
          }

          alert("Formulário enviado com sucesso!");
          window.location.href = "/home.html";
        } catch (e) {
          console.error("Falha inesperada ao salvar registro de anormalidade:", e);
          alert("Erro inesperado ao salvar o formulário. Tente novamente.");
        }
      });

      // Botão Voltar — por enquanto sem ação (deixado propositalmente em branco)
      document.getElementById("btn-voltar").addEventListener("click", () => { /* reservado */ });
    });


  </script>

  <!-- Proteção/Session drop‑in (mesmo padrão das demais páginas) -->
  <script src="/js/session-autoload.js"></script>
</body>

</html>