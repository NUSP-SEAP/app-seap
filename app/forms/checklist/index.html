<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Testes Diários</title>
    <meta name="robots" content="noindex,nofollow" />
    <style>
        :root {
            --gap: 12px;
            --radius: 10px;
            --shadow: 0 1px 3px rgba(0, 0, 0, .08);
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
            background: #f6f7f9;
            color: #0f172a;
        }

        main {
            max-width: 980px;
            margin: 24px auto 56px;
            padding: 0 16px;
        }

        .card {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        h1 {
            margin: 0 0 12px;
            font-size: 1.6rem;
        }

        .muted {
            color: #616a7a;
            font-size: .92rem;
        }

        .grid {
            display: grid;
            gap: var(--gap);
        }

        .grid-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        label {
            font-weight: 600;
            font-size: .95rem;
            display: block;
            margin-bottom: 6px;
        }

        input,
        select,
        textarea {
            width: 100%;
            border: 1px solid #d7dbe3;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 1rem;
            background: #fff;
        }

        select:disabled {
            background: #f2f4f7;
        }

        textarea {
            min-height: 110px;
            resize: vertical;
        }

        .required::after {
            content: " *";
            color: #d00;
        }

        .section-title {
            margin: 22px 0 6px;
            font-weight: 700;
            color: #334155;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        button,
        .btn {
            border: 0;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: #0b5ed7;
            color: #fff;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #1b1f24;
        }

        .badge {
            display: inline-block;
            background: #eef2ff;
            color: #334155;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: .85rem;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        /* Itens (Ok/Falha) */
        .checklist {
            display: grid;
            gap: 10px;
        }

        .check-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
        }

        .check-item-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .check-item label.radio {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-right: 16px;
            font-weight: 500;
        }

        .falha-descricao {
            display: none;
            margin-top: 10px;
        }

        @media (max-width:720px) {

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div id="app-header"></div>
    <main>
        <div class="card">
            <h1>Testes Diários</h1>
            <p class="muted">Preencha os dados e marque o status de cada item.</p>

            <form id="form-checklist" novalidate>
                <!-- Horários automáticos (campos ocultos) -->
                <input type="hidden" id="hora_inicio_testes" name="hora_inicio_testes" />
                <input type="hidden" id="hora_termino_testes" name="hora_termino_testes" />

                <!-- 1) Identificação -->
                <div class="section-title">1) Identificação</div>
                <div class="grid grid-3">
                    <div>
                        <label class="required" for="data_operacao">Data da operação</label>
                        <input type="date" id="data_operacao" name="data_operacao" required />
                    </div>
                    <div>
                        <label class="required" for="sala_id">Local do Evento</label>
                        <select id="sala_id" name="sala_id" disabled required>
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div>
                        <label class="required" for="turno">Turno</label>
                        <select id="turno" name="turno" required>
                            <option value="">Selecione...</option>
                            <option value="Matutino">Matutino</option>
                            <option value="Vespertino">Vespertino</option>
                        </select>
                    </div>
                </div>

                <!-- 2) Itens do teste -->
                <div class="section-title">2) Itens do teste</div>
                <div class="checklist">
                    <div class="check-item">
                        <span class="check-item-label">Sistema Zoom</span>
                        <label class="radio"><input type="radio" name="sistemaZoom" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="sistemaZoom" value="Falha"> Falha</label>
                        <textarea id="falhaSistemaZoom" class="falha-descricao" name="falhaSistemaZoom"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">PC do Secretário</span>
                        <label class="radio"><input type="radio" name="pcSecretario" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="pcSecretario" value="Falha"> Falha</label>
                        <textarea id="falhaPcSecretario" class="falha-descricao" name="falhaPcSecretario"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">Vídeowall</span>
                        <label class="radio"><input type="radio" name="videowall" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="videowall" value="Falha"> Falha</label>
                        <textarea id="falhaVideowall" class="falha-descricao" name="falhaVideowall"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">Mic sem fio</span>
                        <label class="radio"><input type="radio" name="micSemFio" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="micSemFio" value="Falha"> Falha</label>
                        <textarea id="falhaMicSemFio" class="falha-descricao" name="falhaMicSemFio"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">Mic de bancada</span>
                        <label class="radio"><input type="radio" name="micBancada" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="micBancada" value="Falha"> Falha</label>
                        <textarea id="falhaMicBancada" class="falha-descricao" name="falhaMicBancada"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">Sinal TV Senado</span>
                        <label class="radio"><input type="radio" name="sinalTVSenado" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="sinalTVSenado" value="Falha"> Falha</label>
                        <textarea id="falhaSinalTVSenado" class="falha-descricao" name="falhaSinalTVSenado"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">Tablet Presidente</span>
                        <label class="radio"><input type="radio" name="tabletPresidente" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="tabletPresidente" value="Falha"> Falha</label>
                        <textarea id="falhaTabletPresidente" class="falha-descricao" name="falhaTabletPresidente"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">Tablet Secretária</span>
                        <label class="radio"><input type="radio" name="tabletSecretaria" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="tabletSecretaria" value="Falha"> Falha</label>
                        <textarea id="falhaTabletSecretaria" class="falha-descricao" name="falhaTabletSecretaria"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">Relógio (sincronismo)</span>
                        <label class="radio"><input type="radio" name="relogio" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="relogio" value="Falha"> Falha</label>
                        <textarea id="falhaRelogio" class="falha-descricao" name="falhaRelogio"
                            placeholder="Descreva a falha."></textarea>
                    </div>

                    <div class="check-item">
                        <span class="check-item-label">VIP</span>
                        <label class="radio"><input type="radio" name="vip" value="Ok" required> Ok</label>
                        <label class="radio"><input type="radio" name="vip" value="Falha"> Falha</label>
                        <textarea id="falhaVip" class="falha-descricao" name="falhaVip"
                            placeholder="Descreva a falha."></textarea>
                    </div>
                </div>

                <!-- 3) Recursos/Parâmetros -->
                <div class="section-title">3) Recursos/Parâmetros</div>
                <div class="grid grid-2">
                    <div>
                        <label for="usb_01">USB 01</label>
                        <input type="text" id="usb_01" name="usb_01" placeholder="USB / Tascam" />
                    </div>
                    <div>
                        <label for="usb_02">USB 02</label>
                        <input type="text" id="usb_02" name="usb_02" placeholder="USB / Tascam" />
                    </div>
                </div>

                <!-- 4) Observações -->
                <div class="section-title">4) Observações</div>
                <div>
                    <label for="observacoes">Anotações gerais</label>
                    <textarea id="observacoes" name="observacoes" placeholder="Opcional."></textarea>
                </div>

                <!-- Ações -->
                <div class="actions">
                    <a href="/home.html" class="btn btn-secondary">Voltar</a>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>

                <!-- feedback -->
                <div id="msg" class="card hidden" style="margin-top:12px;"></div>
            </form>
        </div>
    </main>
    <div id="app-footer"></div>

    <script>
        // ====== Config (lookups) — já migrado p/ Django ======
        const SALAS_URL = "https://senado-nusp.cloud/webhook/forms/lookup/salas";

        // ====== Estado dos horários (não exibidos) ======
        let _entradaPagina = null; // Date da entrada
        function hhmmss(d) { const p = n => String(n).padStart(2, "0"); return p(d.getHours()) + ":" + p(d.getMinutes()) + ":" + p(d.getSeconds()); }

        // ====== UI helpers ======
        const $ = (sel) => document.querySelector(sel);
        function showMsg(html, ok = true) {
            const box = $("#msg");
            box.classList.remove("hidden");
            box.style.borderColor = ok ? "#16a34a" : "#dc2626";
            box.innerHTML = html;
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        // Exibe/oculta textarea quando marcar "Falha"
        function bindConditionalFailures() {
            const radios = document.querySelectorAll('.check-item input[type="radio"]');
            radios.forEach(r => {
                r.addEventListener('change', (e) => {
                    const name = e.target.name; // ex.: sistemaZoom
                    const area = document.getElementById('falha' + name.charAt(0).toUpperCase() + name.slice(1));
                    if (!area) return;
                    if (e.target.value === 'Falha' && e.target.checked) {
                        area.style.display = 'block';
                    } else {
                        area.style.display = 'none';
                        area.value = '';
                    }
                });
            });
        }

        async function loadSalas() {
            const sel = document.getElementById('sala_id');
            sel.innerHTML = '<option value="">Carregando...</option>';
            try {
                let resp;
                if (window.Auth && Auth.authFetch) resp = await Auth.authFetch(SALAS_URL, { method: 'GET' });
                else {
                    const headers = new Headers();
                    const tok = localStorage.getItem('auth_token') || '';
                    if (tok) headers.set('Authorization', 'Bearer ' + tok);
                    resp = await fetch(SALAS_URL, { method: 'GET', headers });
                }
                const json = await resp.json().catch(() => ({}));
                const rows = Array.isArray(json?.data) ? json.data : (Array.isArray(json) ? json : []);
                const opts = ['<option value="">Selecione...</option>'].concat(
                    rows.map(r => `<option value="${r.id}">${r.nome}</option>`)
                ).join('');
                sel.innerHTML = opts;
                sel.disabled = false;
            } catch (e) {
                sel.innerHTML = '<option value="">Falha ao carregar</option>';
            }
        }

        function readItens() {
            // Nome exatamente como no catálogo (forms.checklist_item_tipo) para mapeamento no back-end.
            const m = (name, label) => {
                const v = (document.querySelector(`input[name="${name}"]:checked`) || {}).value || null;
                const desc = (document.getElementById('falha' + name.charAt(0).toUpperCase() + name.slice(1)) || {}).value || null;
                return { nome: label, status: v, descricao_falha: desc && desc.trim() ? desc.trim() : null };
            };
            return [
                m('sistemaZoom', 'Sistema Zoom'),
                m('pcSecretario', 'PC do Secretário'),
                m('videowall', 'Vídeowall'),
                m('micSemFio', 'Mic sem fio'),
                m('micBancada', 'Mic de bancada'),
                m('sinalTVSenado', 'Sinal TV Senado'),
                m('tabletPresidente', 'Tablet Presidente'),
                m('tabletSecretaria', 'Tablet Secretária'),
                m('relogio', 'Relógio (sincronismo)'),
                m('vip', 'VIP')
            ];
        }

        function buildPayload() {
            const now = new Date();
            const byId = (id) => (document.getElementById(id)?.value || "");
            const toNull = (s) => {
                const v = (s || "").trim();
                return v ? v : null;
            };
            return {
                // Cabeçalho
                data_operacao: byId('data_operacao') || null,                           // YYYY-MM-DD
                sala_id: parseInt(byId('sala_id') || "", 10) || null,                   // FK (smallint)
                turno: byId('turno') || null,                                           // 'Matutino' | 'Vespertino'

                // Horários automáticos (sem inputs visíveis)
                hora_inicio_testes: _entradaPagina ? hhmmss(_entradaPagina) : null,     // HH:MM:SS
                hora_termino_testes: hhmmss(now),                                       // HH:MM:SS

                // NOVO: Recursos/Parâmetros
                usb_01: toNull(byId('usb_01')),                                         // opcional
                usb_02: toNull(byId('usb_02')),                                         // opcional

                // Observações
                observacoes: toNull(byId('observacoes')),                                // opcional

                // Itens do teste
                itens: readItens()                                                       // [{nome,status,descricao_falha}, ...]
            };
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 1) Define data padrão e captura horário de entrada (inicio dos testes)
            document.getElementById('data_operacao').valueAsDate = new Date();
            _entradaPagina = new Date();

            // 2) Carrega salas
            await loadSalas();

            // 3) Liga lógica de "Falha" -> textarea
            bindConditionalFailures();

            // 4) Submit (envia para o back-end Django)
            document.getElementById('form-checklist').addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const form = ev.currentTarget;
                if (!form.checkValidity()) { form.reportValidity(); return; }

                const payload = buildPayload();

                const btn = form.querySelector('button[type="submit"]');
                const old = btn ? btn.textContent : null;
                if (btn) { btn.disabled = true; btn.textContent = 'Salvando...'; }

                try {
                    const url = 'https://senado-nusp.cloud/webhook/forms/checklist/registro';

                    let resp;
                    if (window.Auth && Auth.authFetch) {
                        resp = await Auth.authFetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                    } else {
                        const headers = new Headers({ 'Content-Type': 'application/json' });
                        const tok = localStorage.getItem('auth_token') || '';
                        if (tok) headers.set('Authorization', 'Bearer ' + tok);
                        resp = await fetch(url, { method: 'POST', headers, body: JSON.stringify(payload) });
                    }

                    if (resp.status === 401 || resp.status === 403) {
                        alert('Sua sessão expirou ou você não tem permissão. Faça login novamente.');
                        window.location.href = '/index.html';
                        return;
                    }

                    const data = await resp.json().catch(() => ({}));

                    if (resp.ok) {
                        // Sucesso: não exibe ID, só a mensagem simples
                        alert('Formulário enviado com sucesso!');
                        form.reset();
                        _entradaPagina = new Date(); // reinicia contador de entrada
                    } else {
                        const msg = data?.message || data?.error || ('Falha ao salvar (HTTP ' + resp.status + ')');
                        alert('Não foi possível salvar. ' + msg);
                    }
                } catch (e) {
                    console.error(e);
                    alert('Erro de rede ao tentar salvar o checklist.');
                } finally {
                    if (btn) { btn.disabled = false; btn.textContent = old || 'Salvar'; }
                }
            });

        });
    </script>

    <script>
        (function () {
            // Referências do formulário e campos ocultos
            const form = document.getElementById('form-checklist');
            const inputInicio = document.getElementById('hora_inicio_testes');
            const inputTermino = document.getElementById('hora_termino_testes');
            const btnVoltar = document.getElementById('btn-voltar'); // se existir

            // Utilitários de formatação "HH:MM:SS"
            const pad2 = n => String(n).padStart(2, '0');
            const fmtTime = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

            // 1) Grava o horário exato de ENTRADA na página
            const pageEnter = new Date();
            if (inputInicio) {
                inputInicio.value = fmtTime(pageEnter);
            }

            // 2) No SUBMIT, grava o horário exato de TÉRMINO e deixa o navegador enviar
            if (form) {
                form.addEventListener('submit', function () {
                    if (inputTermino) {
                        inputTermino.value = fmtTime(new Date());
                    }
                }, { capture: true }); // garante que rode antes de qualquer handler posterior
            }

            // 3) Botão "Voltar" para a Home (se o botão existir na página)
            if (btnVoltar) {
                btnVoltar.addEventListener('click', function (e) {
                    e.preventDefault();
                    window.location.href = '/home.html';
                });
            }
        })();
    </script>

    <!-- Sessão + header/footer automáticos (padrão do projeto) -->
    <script src="/js/session-autoload.js"></script>
</body>

</html>